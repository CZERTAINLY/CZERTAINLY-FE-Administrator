name: Build Preview Docker image

on:
  workflow_dispatch:
    inputs:
      pr_number:   { description: "PR number", required: true }
      head_sha:    { description: "Head commit SHA", required: true }
      head_repo:   { description: "Fork repo full_name", required: true }
      head_branch: { description: "Fork branch", required: true }
      base_ref:    { description: "Base branch", required: true }

# What appears in the Actions list
run-name: >-
  Docker Preview • PR #${{ inputs.pr_number }}
  • ${{ inputs.head_repo }}@${{ inputs.head_branch }}
  • ${{ inputs.head_sha }}

permissions:
  contents: read
  checks: write
  pull-requests: read

jobs:
  build_preview_image:
    name: Build docker preview • PR #${{ inputs.pr_number }}
    runs-on: ubuntu-latest

    steps:
      - name: Export context
        run: |
          echo "PR_NUMBER=${{ inputs.pr_number }}"   >> $GITHUB_ENV
          echo "HEAD_SHA=${{ inputs.head_sha }}"     >> $GITHUB_ENV
          echo "HEAD_REPO=${{ inputs.head_repo }}"   >> $GITHUB_ENV
          echo "PR_BRANCH=${{ inputs.head_branch }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ inputs.base_ref }}"  >> $GITHUB_ENV

      - name: Generate token
        id: app_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.SONAR_GH_APP_ID }}
          private_key: ${{ secrets.SONAR_GH_APP_PRIVATE_KEY }}

      - name: Create GitHub Check (in_progress)
        id: create_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app_token.outputs.token }}
          script: |
            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: `Docker preview build`,
              head_sha: process.env.HEAD_SHA,
              status: "in_progress"
            });
            core.setOutput("check_id", check.data.id);

      # Checkout fork PR branch + fetch base to compute diff
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.HEAD_REPO }}
          ref: ${{ env.PR_BRANCH }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git remote add upstream ${{ github.event.repository.clone_url }}
          git fetch upstream $BASE_BRANCH
          git checkout -B "$BASE_BRANCH" "upstream/$BASE_BRANCH"
          git checkout "$PR_BRANCH"
          git clean -ffdx && git reset --hard HEAD

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.3key.company
          username: ${{ secrets.HARBOR_3KEY_USERNAME }}
          password: ${{ secrets.HARBOR_3KEY_PASSWORD }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            harbor.3key.company/czertainly/czertainly-frontend-administrator
          tags: |
            type=sha,prefix=pr-${{ github.event.pull_request.number }}-,format=long

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        id: build-and-push
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          file: ./Dockerfile
          push: true
          provenance: mode=max
          sbom: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
